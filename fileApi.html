<!doctype html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang=""> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8" lang=""> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9" lang=""> <![endif]-->

<!--[if gt IE 8]><!--> <html class="no-js" lang=""> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Mega Série HTML5 - File Api</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="apple-touch-icon" href="apple-touch-icon.png">

        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" href="css/bootstrap-theme.min.css">
        <link rel="stylesheet" href="css/main.css">
        
        <style>
            .btn-file {
              position: relative;
              overflow: hidden;
            }
            .btn-file input[type=file] {
              position: absolute;
              top: 0;
              right: 0;
              min-width: 100%;
              min-height: 100%;
              font-size: 999px;
              text-align: right;
              filter: alpha(opacity=0);
              opacity: 0;
              background: red;
              cursor: inherit;
              display: block;
            }
            input[readonly] {
              background-color: white !important;
              cursor: text !important;
            }
        </style>

        <!-- Incluindo a biblioteca Modernizr no projeto -->
        <script src="js/vendor/modernizr/modernizr.js"></script>
        
        <script>
            
          /* Feature Detection - Inicio */    
            
          //Teste de compatibilidade - opção 1
          //if (window.File && window.FileReader && window.FileList) {}
            
          //Teste de compatibilidade da API File usando Modernizr - opção 2
          //Importante: incluir a feature filereader na biblioteca modernizr.
          //O teste Modernizr.filereader já considera File, FileReader e FileList
          if(Modernizr.filereader) {
            console.info("File API Compatível com este navegador");
          } else {
            console.info("File API Não Compatível com este navegador");
          }
          
          /* Feature Detection - Fim */    
            
        </script>
        

    </head>
    
    
    <body>
        <!--[if lt IE 8]>
            <p class="browserupgrade">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->
    <nav class="navbar navbar-inverse navbar-fixed-top" role="navigation">
      <div class="container">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Meu Projeto HTML5</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
         
        </div><!--/.navbar-collapse -->
      </div>
    </nav>

    <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
      <div class="container">
        <h1>Html 5 - File API</h1>
        <p>Neste conjunto de aulas eu explico, passo a passo, como usar a File API e seus principais recursos. 
        Quer aprender mais sobre desenvolvimento Web e Hibrido? Então visite meu Blog e Canal</p>
        <p><a class="btn btn-primary btn-lg" href="http://blog.sw9.com.br" role="button">Ir Para o Meu Blog &raquo;</a></p>
      </div>
    </div>
    <div class="container">
       <div class="block">
          <ol class="breadcrumb">
            <li><a href="index.html">Principal</a></li>
            <li class="active"><a href="fileApi.html">File Api</a></li>
            
          </ol>
        </div>
    </div>
    
    <div class="container">
      
      <!-- Inicio:: Area de upload de arquivos | Vamos trabalhar apenas com imagem -->
      <div class="row" id="fileZone">
           <div class="col-md-8">
             <div class="panel panel-danger">
                  <div class="panel-heading">
                    <h3 class="panel-title">Galeria de Imagens</h3>
                  </div>
                  <div class="panel-body">
                  
                     <div class="input-group">
                      <span class="input-group-btn">
                        <span class="btn btn-default btn-file">
                          Selecione... 
                          <!-- Inicio:: campo do tipo file que permite selecionar mais de um arquivo graças ao atributo [multiple] -->
                         <input type="file" id="loadFile" multiple accept="image/*">
                         <!-- Fim:: campo do tipo file que permite selecionar mais de um arquivo graças ao atributo [multiple] -->
                        </span>
                      </span>
                      <input readonly="readonly" placeholder="Nenhuma Imagem Selecionada" class="form-control" id="fileCount" type="text">
                    </div>
                    <br>
                    <!-- Inicio:: Exibe Lista de Erros de Validação -->    
                    <div id="errorList"></div>
                    <!-- Fim:: Exibe Lista de Erros de Validação --> 
                     
                    <!-- Inicio:: Exibe Lista de Imagens Carregadas (incluindo thumbnail) -->
                    <div id ="imageList"></div>
                    <!-- Fim:: Exibe Lista de Imagens Carregadas (incluindo thumbnail) -->
                  
                  </div>
             </div>
          </div>
      </div>  
      <!-- Fim:: Area de upload de arquivos | Vamos trabalhar apenas com imagem -->
      
        <hr>
  
        <footer>
          <p>&copy; SW9 - 2018</p>
        </footer>
    </div> 
    <!-- /container -->   

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.2.min.js"><\/script>')</script>
    
        <script src="js/vendor/bootstrap.min.js"></script>
        
        <!-- Google Analytics: change UA-XXXXX-X to be your site's ID. -->
        <script>
            (function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=
            function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;
            e=o.createElement(i);r=o.getElementsByTagName(i)[0];
            e.src='//www.google-analytics.com/analytics.js';
            r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));
            ga('create','UA-XXXXX-X','auto');ga('send','pageview');
        </script>
        
       <script>
            
            //Inicio:: Obtendo elementos da area de upload de arquivos   
            const loadFile = document.getElementById("loadFile");
            const imageList = document.getElementById("imageList");      
            const errorList = document.getElementById("errorList"); 
            const fileCount = document.getElementById("fileCount"); 
            //Fim          
            
                 
            //Se o navegador é compativel com addEventListener          
            if (loadFile.addEventListener) {     
            
               console.log("Usando addEventListener => compativel com todos os navegadores, exceto IE 8 e versões anteriores");
               
               //Adiciona escuta ao evento change.  Todas as vezes que o botão id=loadFile for clicado e arquivos forem selecionados,
               //o evento change é disparado e a função fileAction é chamada
               loadFile.addEventListener("change", function(){ fileAction(this); } , false);
               
            } else if (loadFile.attachEvent) { //Caso contrário usa attachEvent para registrar eventos  
            
               console.log("Usando attachEvent => compativel com IE 8 e versões anteriores");
               
               //Adiciona escuta ao evento change.  Todas as vezes que o botão id=loadFile for clicado e arquivos forem selecionados,
               //o evento change é disparado e a função fileAction é chamada
               loadFile.attachEvent("onchange", function(){ fileAction(this); });
               
            }
         
            //Função: fileAction
            //Parametros: object = objecto file ou lista de objetos do tipo file
            //Objetivo: disparada pelo evento change, esta função é encarregada de tratar toda a lógica do upload
            function fileAction(object) {
                
                //object.files pode representar:
                //1- objeto File (em caso de seleção de apenas 1 arquivo)
                //2- objeto FileList (em caso de seleção de mais de 1 arquivo)
                let files = object.files;
                let error = [];
                
                
                //Exibe quantidade de imagens selecionadas ao lado do botão de seleção de arquivos
                fileCount.value = (files.length > 1) ? files.length + ' Imagens Selecionadas' : files.length + ' Imagem Selecionada';
                
                //Percorrendo a lista de objetos do tipo file
                for (var i = 0, f; f = files[i]; i++) {
                    
                    if(isMaxSize(f)) {
                        error.push(f.name);
                    } else {
                        
                    //uId - geração de id unico para cada arquivo
                    let uId = Date.now() + Math.random().toString().slice(2);
                    
                    //
                    renderImage(f, uId);
                    //addItem(f, i);
                    
                    }
                    
                }
                
                (error.length > 0) ? addError(error) : errorList.innerHTML = '';
               
            }
         
            //Função: renderImage
            //Parametros: file = objeto do tipo file (contém informações sobre o arquivo), uId = id unico do arquivo
            //Objetivos: 
            //    1- Verifica se o arquivo é do tipo imagem. Apenas nesta condição, as demais instruções são executadas
            //    2- Lê arquivo, converte de Blob(binário) para dataURL de forma que o navegador consiga renderizar o conteúdo
            //    3- Exibe thumbnail e dados da imagem na tela
            
            function renderImage(file, uId) {
                 
                  console.log("ID => ", uId);
                  console.log("File => ", file);
             
                 //Uso de mimetype para verificar se arquivo é do tipo imagem
                 if (file.type.match('image.*')) {
                 
                     //Novo objeto FileReader para ler o arquivo
                     const reader = new FileReader();
                     
                     //Evento onload, disparado após o término da leitura do arquivo (readAsDataURL)
                     reader.onload = (function(currentFile) {
                         return function(event) {
                           
                            //Chama função para atualizar item da galeria.                		
                            //Troca progressBar por thumbnail.   
                            //event.target.result = conteúdo do arquivo convertido em DataURL
                            updateItem(uId, event.target.result);
                               
                         };
                     })(file); 
                    
                    //Faz a leitura do arquivo convertendo de Blob(binário) para DataURL. Ao término da leitura, o evento onload é disparado e o resultado
                    //pode ser obtido usando o código event.target.result
                    reader.readAsDataURL(file);   
                    
                     /* Evento abort */
                     reader.onabort = function () {
                  	
                        document.getElementById("cancel-" + uId).remove();
                  
                        console.log("Arquivo => ", uId, " cancelado");     
                  
                    };
                    
          
                    /* Evento loadstart */
                    reader.onloadstart = function(event) {
                      
                        console.log(file.name + " " + uId);
                        
                        //Adiciona Item na galeria de imagens, exibindo progressBar, nome e tamanho do arquivo
                        addItem(file, uId, event);  
                      
                    };      
                    
                    /* Evento progress */
                    reader.onprogress = (function(currentFile) {
                      
                         return function(event) {
                           
                            var str = ["File Name => " + currentFile.name, " bytes => " + currentFile.size, " Loaded => " + event.loaded, " Total => " + event.total].join(" |");
                           
                            console.log(str);
                            
                            //Atualiza barra de progresso
                            updateProgress(uId, event);
                                
                               
                         };
                     })(file); 
                     
                     
                     //Parametros: evento = informações retornadas pelo evento de erro
                    //Objetivo: Exibir mensagem de erro no console, caso ocorra alguma exceção durante a leitura de arquivo.
                    //O evento error devolve o nome do erro e mensagem:
                    //event.target.error.name e eventtarget.error.message
                    reader.onerror = function(event) {
                    	
                    	const err = ['Arquivo => ' + file.name, 'Uid => ' + uId, 'Erro Encontrado => ' + event.target.error.name + ' - ' + event.target.error.message];
                    
                    	console.log("Erro Encontrado => ", err);
                    	
                    	document.getElementById("cancel-" + uId).remove();
                      
                    };

                    //Outra opção para registro de erros
                    //o evento loadend é disparado quando uma operação de leitura é concluída com sucesso ou falha
                    //neste caso seria possível checar se event.target.error é diferente de vazio
                    reader.onloadend = function(event) {
                      
                      if(event.target.error !== null) {
                    	console.log("Encerrado com Erro => ", event);
                      }
                      
                    };
    
                 }
            }
            
            
            //Função: updateProgress
            //Parametros: uId = id unico do arquivo, event = evento do tipo progress
            //Objetivo: a partir do evento do tipo progress é possível consultar as propriedades
            //loaded = quantidade de bytes já lidos até o momento
            //total = quantidade de bytes total do arquivo
            //lenghtComputable = booleano que indica se o tamanho do arquivo é conhecido ou não
           
            function updateProgress(uId, event) {
              
              if (event.lengthComputable) {
                
                //Calcula o percentual atual
                let percentLoaded = Math.round((event.loaded / event.total) * 100);
                
                //Atualiza o progressBar correspondente
                document.getElementById("progress-bar-" + uId).value = percentLoaded;
                
                //console.log(uId, " | ", event.loaded, " | ", percentLoaded);
               
              }
              
            }
            
            //Função: updateItem
            //Parametros: uId = id unico do arquivo, result = conteúdo do arquivo convertido para DataURL
            //Objetivo: Troca o elemento progressBar (100% carregado), pela miniatura da imagem (thumbnail)
           
            function updateItem (uId, result) {
          
                //Troca progressBar por thumbnail
                document.getElementById(uId).innerHTML = "<image width='50px' height='50px' src='" +  result + "' />";
              
            }
            
            //Função: addItem
            //Parametros: currentFile = objeto file atual, uId = id unico do arquivo, event = evento progress
            //Objetivo: Exibe no navegador o progressBar, botão cancelar, nome e tamanho da imagem
                       
            
            function addItem (currentFile, uId, event) {
            
            	const div = document.createElement("div");
            	
            	const divBody = document.createElement("div");
            	const divHeader = document.createElement("div");
            	const divFile = document.createElement("div");
            	
            	const btn = document.createElement("button");
            	let content = '';
            
            	//Define um conjunto de estilos para o element div recém criado
            	div.className = "alert alert-warning alert-dismissible";
            	div.id = "cancel-" + uId;
              
            	divBody.id = uId;
              
            	btn.className = "btn btn-danger";
            	btn.innerHTML = "<i class='glyphicon glyphicon-remove'></i> Cancelar... ";
            	btn.onclick =  function() {
            	  
            	  console.log("Abortando => ", event.target); 
            	  
            	  event.target.abort();
            	  
            	  return true;
            	};
            	
            	//Cria o conteúdo que será exibido no navegador
            	divHeader.innerHTML = "<button type='button' class='close' data-dismiss='alert' aria-label='Close'><span aria-hidden='true'>&times;</span></button>";
            	
            	divBody.innerHTML = "<progress id='progress-bar-" + uId + "' max=100 value=0></progress>&nbsp;&nbsp;";
            	divBody.appendChild(btn);
            	
            	divFile.innerHTML = "<strong>" + currentFile.name + "</strong> - " + humanFileSize(currentFile.size, 'MB'); 
            	//
            
            	//Associa conteúdo ao elemento div
            	div.appendChild(divHeader);
            	div.appendChild(divBody);
            	div.appendChild(divFile);
            	
            	//Faz o append do conteúdo na área que lista as imagens
            	imageList.appendChild(div);
            	
              
            }
            
           
            
          //http://stackoverflow.com/questions/10420352/converting-file-size-in-bytes-to-human-readable
        	
        	function humanFileSize(bytes, si) {
        	    var thresh = si ? 1000 : 1024;
        	    if(bytes < thresh) return bytes + ' B';
        	    var units = si ? ['kB','MB','GB','TB','PB','EB','ZB','YB'] : ['KiB','MiB','GiB','TiB','PiB','EiB','ZiB','YiB'];
        	    var u = -1;
        	    do {
        	        bytes /= thresh;
        	        ++u;
        	    } while(bytes >= thresh);
        	    return bytes.toFixed(1)+' '+units[u];
        	}


            //Função: validateMaxSize
            //Parametros: file = objeto file contendo informações do arquivo
            //Objetivo: Graças a File API, é possível realizarmos uma série de validações, sem precisarmos enviarmos o arquivo para o servidor.
            //As validações podem ser feitas do lado do cliente
            //Apenas como exemplo, esta função vai validar se um determinado arquivo possui mais do que 1 Mb de tamanho.
            //Caso possua mais de 1 MB, será exibido um erro ao usuário e o arquivo não será lido e exibido.
            
            function isMaxSize (file) {
               
               //Tamanho máximo permitido por arquivo: 6 MB = 6291456 Bytes (em binário)
               if (file.size > 6291456) {
            	   return true;
               } else {
            	   return false;
               }
               
            }

           //Função: addError
            //Parametros: errorArr = array contendo os erros registrados pela rotina de validação
            //Objetivo: Exibe os erros encontrados na área de erros definida como id=errorList
           
            function addError (errorArr) {
                
                  let html = "<div class='alert alert-danger alert-dismissible'>";
                      html += "Limite Excedido | Só é permitido carregar arquivos menores ou iguais a 6 Mb.<br>Arquivos afetados: " + errorArr.join(' - ');
                
                errorList.innerHTML = html; 
                    
            }
         
       </script>
        
    </body>
</html>